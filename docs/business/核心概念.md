# 核心概念定義

> ⚠️ **重要:本文檔是所有核心概念的唯一權威定義來源**
>
> 其他文檔應通過連結引用此處定義,而非重複說明。
> 如需修改概念定義,請只在此文檔中修改。

---

## 📋 目錄

1. [最早預約 (Earliest Appointment)](#最早預約)
2. [活躍預約 (Active Appointment)](#活躍預約)
3. [非活躍預約 (Inactive Appointment)](#非活躍預約)
4. [自動補位 (Auto Replacement)](#自動補位)
5. [門市群組 (Store Group)](#門市群組)
6. [簡訊發送規則](#簡訊發送規則)

---

## 1. 最早預約 (Earliest Appointment) {#最早預約}

### 定義

**同一會員、同一天、同一門市群組(或同門市)內,時間最早的活躍預約。**

### 判斷規則

1. **第一步:篩選範圍**
   - 同一會員 (`RecordNo` 相同)
   - 同一日期
   - 同一門市群組 (`SYSGroup` 相同) 或 同一門市 (`CompanyId` 相同)

2. **第二步:排除已失效預約**
   - ❌ 已取消 (`appointmentStatus === 'cancelled'`)
   - ❌ 已送達 (`smsStatus === 'delivered'`)
   - ❌ 已過期 (`isAppointmentExpired === true`)

3. **第三步:選擇最早**
   - 在剩餘的「活躍預約」中,選擇時間最早的
   - 時間相同時,選擇 ID 較小的

### 示例

```
王大明 - 2025/11/02 - 板橋區域(群組3)
├─ 09:00 未發送  ← ✅ 活躍預約中最早
├─ 14:00 未發送  ← ❌ 活躍但非最早
└─ 16:00 未發送  ← ❌ 活躍但非最早
```

### 相關連結

- [活躍預約定義](#活躍預約)
- [自動補位邏輯](#自動補位)
- [API 實現](/docs/technical/API文檔.md#判斷最早預約)
- [UI 展示](/docs/design/UI設計規範.md#預約狀態)

---

## 2. 活躍預約 (Active Appointment) {#活躍預約}

### 定義

**可能發送簡訊的預約,即尚未完成或失效的預約。**

### 判斷規則

預約的簡訊狀態符合以下任一條件:

- ✅ **未發送** (`smsStatus === ''` 或 `null`)
- ✅ **排程中** (`smsStatus === 'scheduled'`)
- ✅ **發送失敗** (`smsStatus === 'failed'`)

且預約本身狀態為:

- ✅ **未取消** (`appointmentStatus !== 'cancelled'`)
- ✅ **未過期** (`isAppointmentExpired === false`)

### 操作權限

**只有「活躍預約中的最早預約」可以操作簡訊狀態。**

支援的操作:
- 📤 發送簡訊
- 🚫 取消簡訊
- 🔄 重新發送簡訊

### 示例

```javascript
// 活躍預約示例
{
  id: 24,
  date: '2025/11/02',
  time: '09:00',
  smsStatus: '',              // ✅ 未發送
  appointmentStatus: '',      // ✅ 未取消
  isAppointmentExpired: false // ✅ 未過期
}
// → 這是活躍預約
```

### 相關連結

- [非活躍預約定義](#非活躍預約)
- [最早預約判斷](#最早預約)
- [預約查詢操作說明](/docs/guides/操作員手冊.md#預約查詢)

---

## 3. 非活躍預約 (Inactive Appointment) {#非活躍預約}

### 定義

**不會再發送簡訊的預約,包括已完成、已失效或非最早的預約。**

### 分類

#### 3.1 非最早預約
- **狀態:** 活躍但非最早
- **顯示:** 顯示原簡訊狀態(半透明 opacity: 0.5)
- **操作:** 不可操作

#### 3.2 已取消/已刪除預約
- **狀態:** `appointmentStatus === 'cancelled'`
- **顯示:** 顯示「已取消」(灰色)
- **操作:** 不可操作

#### 3.3 已送達或已過期預約
- **狀態:** `smsStatus === 'delivered'` 或 `isAppointmentExpired === true`
- **顯示:** 顯示實際狀態(「已送達」或「已過期」)
- **操作:** 不可操作

### UI 視覺規範

| 狀態類型 | 可操作 | 顏色 | 懸停效果 |
|---------|--------|------|---------|
| 活躍預約(最早) | ✓ | 正常顯示 | 顯示操作按鈕 |
| 非活躍預約(非最早) | ✗ | 半透明(opacity: 0.5) | tooltip: 「非最早預約,不可操作」 |
| 已取消 | ✗ | 灰色 #9e9e9e | 無 |
| 已送達/已過期 | ✗ | 灰色 #9e9e9e | 無 |

### 相關連結

- [活躍預約定義](#活躍預約)
- [UI 設計規範](/docs/design/UI設計規範.md)

---

## 4. 自動補位 (Auto Replacement) {#自動補位}

### 定義

**當取消預約時,系統自動檢查並更新新的最早預約,將簡訊發送權轉移給次早預約。**

### 觸發條件

✅ **會觸發自動補位:**
- 取消預約(`appointmentStatus` 設為 `'cancelled'`)
- 該預約是當天群組/門市內的最早預約
- 存在次早的活躍預約

❌ **不會觸發自動補位:**
- 僅取消簡訊(`smsStatus` 設為 `'cancelled'`)
- 修改預約時間
- 預約不是最早的

### 補位流程

```
1. 檢測取消的預約是否為最早預約
   ↓
2. 查找同日同群組/門市的其他活躍預約
   ↓
3. 選擇次早預約作為新的最早預約
   ↓
4. 彈出情境5彈窗,提示使用者確認
   ↓
5. 使用者確認後,為補位預約發送簡訊
```

### 示例:群組內補位

**初始狀態:**
```
板橋區域(群組3) - 2025/11/13
├─ 09:00 板橋醫美 ✅ 最早(已排程簡訊)
└─ 16:30 板橋岩盤浴 ⏸️ 次早(待補位)
```

**操作:** 取消 09:00 預約

**補位後:**
```
板橋區域(群組3) - 2025/11/13
├─ 09:00 板橋醫美 ❌ 已取消
└─ 16:30 板橋岩盤浴 ✅ 補位為最早(發送簡訊)
```

### 重要原則

- **群組內補位:** 只在同一門市群組內尋找次早預約
- **門市內補位:** 獨立門市只在同一門市內尋找次早預約
- **跨群組不補:** 不同群組或不同獨立門市之間不會互相補位
- **動態更新:** 每次預約變動都會重新計算最早與次早

### 相關連結

- [情境5:自動補位](/docs/design/UI設計規範.md#情境5)
- [取消預約功能說明](/docs/archive/updates/v2.2-取消預約功能.md)

---

## 5. 門市群組 (Store Group) {#門市群組}

### 定義

**消耗區域群組:同一會員可以在群組內不同門市之間互相消耗療程的門市集合。**

### 群組規劃(共 27 個門市)

#### 消耗區域群組(5 組,共 11 家門市)

| 群組編號 | 群組名稱 | 門市列表 | SYSGroup 值 |
|---------|---------|---------|-------------|
| 群組 1 | 忠孝區域 | 忠孝岩盤浴、忠孝光澤 | 1 |
| 群組 2 | 羅東區域 | 羅東岩盤浴、羅東光澤 | 2 |
| 群組 3 | 板橋區域 | 板橋醫美、板橋岩盤浴 | 3 |
| 群組 4 | 中壢彤顏區域 | 中壢彤顏健保、中壢彤顏醫美、中壢岩盤浴 | 4 |
| 群組 5 | 台中區域 | 台中光澤診所、台中岩盤浴 | 5 |

#### 獨立門市(16 家)

採用「同一門市規則」,`SYSGroup = 0`:

南西光澤診所、永和彤顏診所、古亭光澤、大直光澤診所、新竹光澤診所、高雄光澤、八德健保診所、三重光澤、桃園岩盤浴、林口彤顏診所、台北岩盤浴、新莊光澤診所、桃園彤顏健保、三峽光澤診所、三民光澤診所、板橋光澤健保

### 規則說明

- **群組規則:** 同一天 + 同一群組 → 只發送最早的一封簡訊
- **同門市規則:** 同一天 + 同一門市 → 只發送最早的簡訊

### 示例

```
客戶在同一天預約:
├─ 09:00 板橋醫美(群組3) → ✅ 發送
├─ 16:00 板橋岩盤浴(群組3) → ❌ 跳過(同群組)
└─ 18:00 三重光澤(獨立) → ✅ 發送(不同群組)

結果:3個預約發送2封簡訊(節省33%)
```

### 相關連結

- [門市群組詳細規劃](/docs/business/門市群組規劃.md)
- [簡訊發送規則](#簡訊發送規則)

---

## 6. 簡訊發送規則 {#簡訊發送規則}

### 核心原則

**「往最早的排程靠齊」**

同一天、同一群組(或同門市)內,只對最早的預約發送簡訊。

### 判斷流程

```
收到預約
   ↓
第一關:客戶資格檢查
   ├─ 黑名單? → ❌ 引導取消發送
   ├─ 白名單? → ✅ 通過
   └─ 電訪銷開關?
   ↓
第二關:SYSGroup 規則判斷
   ├─ 是群組內最早預約? → ✅ 可發送
   ├─ 是同門市最早預約? → ✅ 可發送
   └─ 非最早預約? → ❌ 不發送
   ↓
第三關:彈出發送預覽視窗
   └─ 使用者最終確認
```

### 兩層規則

#### 規則一:消耗區域群組規則(優先)

- 同一天 + 同一門市群組 (`SYSGroup` 相同) → 只發送最早的一封
- 例:板橋醫美 + 板橋岩盤浴屬於群組3,只發一封

#### 規則二:單一門市規則(次要)

- 若門市不在任何群組內 (`SYSGroup = 0`) → 採用「同一門市」規則
- 同一天 + 同一門市 → 只發送最早的簡訊

### 重要前提

- ✅ 每個預約對應一封簡訊的設計不變
- ✅ 僅透過「跳過發送」來達到優化目的
- ✅ 預約不會被擋,簡訊規則只影響發送邏輯

### 相關連結

- [客戶資格檢查規則](/docs/business/客戶資格檢查.md)
- [業務情境案例](/docs/business/業務情境案例.md)
- [UI 彈窗設計](/docs/design/UI設計規範.md)

---

## 📚 相關文檔索引

### 業務文檔
- [簡訊發送規則詳解](/docs/business/簡訊發送規則.md)
- [門市群組規劃](/docs/business/門市群組規劃.md)
- [客戶資格檢查](/docs/business/客戶資格檢查.md)
- [業務情境案例](/docs/business/業務情境案例.md)

### 設計文檔
- [UI 設計規範](/docs/design/UI設計規範.md)
- [彈窗交互模式](/docs/design/彈窗交互模式.md)

### 技術文檔
- [資料庫設計](/docs/technical/資料庫設計.md)
- [API 介面文檔](/docs/technical/API文檔.md)

### 使用指南
- [操作員手冊](/docs/guides/操作員手冊.md)
- [開發者指南](/docs/guides/開發者指南.md)
- [常見問題 FAQ](/docs/guides/FAQ.md)

---

**文檔版本:** v2.3
**最後更新:** 2025-12-03
**維護單位:** Dr. Shine 簡訊管理系統專案組

---

## 📝 文檔維護說明

### 修改此文檔時

1. ✅ 更新「最後更新」日期
2. ✅ 檢查所有引用此概念的文檔
3. ✅ 更新相關連結
4. ✅ 通知相關團隊成員

### 引用此文檔

**正確做法 ✅**
```markdown
[最早預約](/docs/business/核心概念.md#最早預約)的定義是...
```

**錯誤做法 ❌**
```markdown
最早預約是指同一會員、同一天...(重複定義)
```

保持單一真相來源,避免內容重複!
