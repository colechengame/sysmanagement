# 更新說明：移除「已合併」狀態

**更新時間：** 2025-12-01
**版本：** v2.3
**更新內容：** 移除「已合併」狀態概念，改為顯示原本簡訊狀態並設為不可操作

---

## 📋 更新內容

### **問題背景**

v2.1 版本引入了「已合併」狀態來標示非最早預約：
```
王大明 - 2025/11/02
├─ 09:00 未發送  ✅ 可操作
├─ 14:00 已合併  ❌ 不可操作
└─ 16:00 已合併  ❌ 不可操作
```

但這樣會有問題：
- 用戶無法看到非最早預約的實際簡訊狀態
- 「已合併」是新概念，需要培訓
- 不直觀，用戶可能誤以為簡訊已發送

### **解決方案**

**移除「已合併」狀態**，改為：
- ✅ 顯示原本的簡訊狀態（未發送、排程中、已取消等）
- ✅ 非最早預約用半透明（opacity: 0.5）表示不可操作
- ✅ 懸停顯示 tooltip：「非最早預約，不可操作」
- ✅ 不添加操作按鈕

---

## 🔄 行為變更對比

### **變更前（v2.1 - 已合併狀態）**

| 預約 | 時間 | 簡訊管理顯示 | 可操作 |
|------|------|-------------|--------|
| 王大明 #1 | 09:00 | 未發送 | ✅ 可發送 |
| 王大明 #2 | 14:00 | **已合併** | ❌ 不可操作 |
| 王大明 #3 | 16:00 | **已合併** | ❌ 不可操作 |

**問題：** 無法得知 #2、#3 的實際簡訊狀態

---

### **變更後（v2.3 - 顯示原狀態）**

| 預約 | 時間 | 簡訊管理顯示 | 視覺效果 | 可操作 |
|------|------|-------------|---------|--------|
| 王大明 #1 | 09:00 | 未發送 | 正常 | ✅ 可發送 |
| 王大明 #2 | 14:00 | **未發送** | 🔘 半透明 | ❌ 不可操作 |
| 王大明 #3 | 16:00 | **未發送** | 🔘 半透明 | ❌ 不可操作 |

**改進：** 一眼看出所有預約的實際簡訊狀態

---

## 🎨 視覺效果

### **最早預約（可操作）**

```css
/* 正常顯示 */
opacity: 1.0;
cursor: pointer;  /* 懸停顯示操作按鈕 */
```

### **非最早預約（不可操作）**

```css
/* 半透明顯示 */
opacity: 0.5;
cursor: default;  /* 無操作按鈕 */
title: "非最早預約，不可操作"
```

---

## 🧪 測試案例

### **案例 1：同日多預約的狀態顯示**

#### **測試對象**
- **王大明（M001）** - 2025/11/02
  - ID 24: 09:00 - 雷射除斑（smsStatus: ''）
  - ID 25: 14:00 - 醫美諮詢（smsStatus: ''）
  - ID 26: 16:00 - 電波拉提（smsStatus: ''）

#### **預期結果**

| ID | 時間 | 簡訊管理顯示 | 視覺效果 | 懸停效果 |
|----|------|-------------|---------|---------|
| 24 | 09:00 | 未發送 | 正常 | ✅ 顯示「發送簡訊」按鈕 |
| 25 | 14:00 | 未發送 | 半透明 | ❌ 無按鈕，顯示 tooltip |
| 26 | 16:00 | 未發送 | 半透明 | ❌ 無按鈕，顯示 tooltip |

---

### **案例 2：最早預約發送後的狀態變化**

#### **操作步驟**
1. 發送 ID 24（09:00）的簡訊
2. 等待 8 秒發送成功
3. 觀察表格變化

#### **預期結果**

**發送前：**
```
ID 24: 未發送（正常） ← 最早，可操作
ID 25: 未發送（半透明） ← 非最早
ID 26: 未發送（半透明） ← 非最早
```

**發送後 8 秒：**
```
ID 24: 已送達（正常） ← 已失效，不再是最早
ID 25: 未發送（正常） ← 現在是最早，可操作 ✅
ID 26: 未發送（半透明） ← 非最早
```

---

### **案例 3：最早預約取消後的自動補位**

#### **操作步驟**
1. 取消 ID 24 的預約（點擊「取消預約」）
2. 在情境5彈窗中確認發送 ID 25
3. 觀察狀態變化

#### **預期結果**

**取消前：**
```
ID 24: 未發送（正常） ← 最早
ID 25: 未發送（半透明） ← 非最早
ID 26: 未發送（半透明） ← 非最早
```

**取消後：**
```
ID 24: 已取消（灰色） ← appointmentStatus = 'cancelled'
ID 25: 排程中（正常） ← 補位成功，現在是最早 ✅
ID 26: 未發送（半透明） ← 仍非最早
```

---

## 💡 優勢分析

### **v2.1（已合併狀態）的問題**

❌ 用戶看不到非最早預約的實際簡訊狀態
❌ 需要培訓「已合併」的概念
❌ 可能誤以為簡訊已發送或已處理
❌ 無法區分「未發送」、「排程中」、「已取消」等狀態

### **v2.3（顯示原狀態）的優勢**

✅ **直觀**：直接顯示實際簡訊狀態
✅ **透明**：用戶知道每個預約的簡訊狀態
✅ **易懂**：半透明 = 不可操作，無需新概念
✅ **一致**：與原有狀態系統保持一致

---

## 🔧 技術實現

### **核心修改：generateActionButtons()**

#### **變更前（v2.1）**
```javascript
if (!isEarliest) {
    // 非最早預約：顯示「已合併」
    return '<span class="status-merged">已合併</span>';
}
```

#### **變更後（v2.3）**
```javascript
// 先判斷簡訊狀態
if (smsStatus === '') {
    statusClass = 'status-none';
    statusText = '未發送';
} else if (smsStatus === 'scheduled') {
    statusClass = 'status-scheduled';
    statusText = '排程中';
}
// ... 其他狀態

// 非最早預約：顯示原狀態但設為半透明 read-only
if (!isEarliest) {
    html += '<span class="sms-status-block ' + statusClass + '"
             style="opacity: 0.5; cursor: default;"
             title="非最早預約，不可操作">' + statusText + '</span>';
} else {
    // 最早預約：正常顯示 + 操作按鈕
    html += '<span class="sms-status-block ' + statusClass + '">' + statusText + '</span>';
    html += '<div class="sms-hover-actions">...</div>';
}
```

---

## 📊 狀態對照表

| 簡訊狀態 | 最早預約顯示 | 非最早預約顯示 | 可操作 |
|---------|------------|--------------|--------|
| 未發送（''） | 未發送（正常） | 未發送（半透明） | 最早✅ / 非最早❌ |
| 排程中 | 排程中（正常） | 排程中（半透明） | 最早✅ / 非最早❌ |
| 已送達 | 已送達（正常） | 已送達（半透明） | ❌ |
| 已取消 | 已取消（正常） | 已取消（半透明） | 最早✅ / 非最早❌ |
| 發送失敗 | 發送失敗（正常） | 發送失敗（半透明） | 最早✅ / 非最早❌ |

---

## 📝 用戶影響

### **正面影響**
✅ **更直觀**：直接看到所有預約的簡訊狀態
✅ **無需培訓**：半透明 = 不可操作，一目了然
✅ **信息完整**：不隱藏任何簡訊狀態信息

### **注意事項**
⚠️ 半透明的預約仍然無法操作（這是預期行為）
⚠️ 只有最早的有效預約可以操作簡訊

---

## 🚀 升級指南

### **從 v2.1 升級到 v2.3**

**變更內容：**
- 移除「已合併」狀態顯示
- 改為顯示原本簡訊狀態（半透明）

**用戶體驗變化：**
- 看到的狀態文字不同（從「已合併」→「未發送」等）
- 視覺效果更直觀（半透明表示不可操作）

**無需數據遷移**
- 純前端顯示邏輯調整
- 不影響數據結構

---

## 💬 常見問題

### Q1：為什麼非最早預約顯示半透明？

**A：** 半透明（opacity: 0.5）是標準的 UI 設計語言，表示「不可用」或「不可操作」的狀態，用戶無需培訓即可理解。

### Q2：如何知道哪個是最早預約？

**A：**
- 正常顯示（不透明）的就是最早預約
- 半透明的是非最早預約
- 懸停時會顯示提示訊息

### Q3：非最早預約能否單獨發送簡訊？

**A：** 不能。這是業務規則：「同一天只發一封簡訊，以最早預約為準」。非最早預約不提供操作按鈕。

### Q4：如果最早預約被取消，其他預約會怎樣？

**A：** 次早預約會自動成為「最早預約」，變為正常顯示（不透明），並可以操作。

---

## 📖 相關文檔

- `更新說明_取消預約功能.md` - v2.2 取消預約功能說明
- `最早預約邏輯說明.md` - 最早預約判斷邏輯
- `測試指南_完整版.md` - 情境1-5測試指南

---

## ✅ 檢查清單

升級後請確認：

- [ ] 非最早預約顯示原本的簡訊狀態（不是「已合併」）
- [ ] 非最早預約為半透明顯示
- [ ] 懸停非最早預約顯示 tooltip：「非最早預約，不可操作」
- [ ] 非最早預約無操作按鈕
- [ ] 最早預約正常顯示，可操作
- [ ] 最早預約被取消後，次早預約自動變為正常顯示

---

**更新完成！此版本更直觀易懂，無需額外培訓。**
