# 更新說明：取消預約功能與業務規則

**更新時間：** 2025-12-01
**版本：** v2.2
**更新內容：** 新增「取消預約」欄位，區分「取消簡訊」與「取消預約」，實現活躍預約管理

---

## 📋 更新內容

### **問題背景**

之前版本混淆了「取消簡訊」和「取消預約」的概念：
- **取消簡訊**：只是不發送簡訊通知，預約本身仍然有效
- **取消預約**：預約本身被取消，客戶不會來診

這導致：
- 無法正確觸發情境5（自動補位）
- 最早預約的判斷邏輯不清晰
- 用戶操作困惑

### **解決方案**

1. 新增獨立的「取消預約」欄位和按鈕
2. 實現活躍預約管理（只有最早的有效預約可操作簡訊）
3. 區分 `smsStatus` 和 `appointmentStatus` 兩個狀態字段
4. 完善自動補位邏輯（只在取消預約時觸發）

---

## ✅ 功能變更

### **1. 新增「取消預約」欄位**

#### **表格結構變更**

```html
<th>簡訊管理</th>
<th>取消預約</th>  <!-- 新增 -->
<th>聯絡狀況</th>
```

#### **欄位內容**

- **未取消的預約**：顯示「取消預約」按鈕
- **已取消的預約**：顯示灰色「已取消」文字
- **已過期的預約**：顯示灰色「已過期」文字

---

### **2. 活躍預約管理規則**

#### **活躍預約（可操作簡訊）**

只有**最早的有效預約**可以操作簡訊狀態：
- ✅ 支援操作：發送、取消、重新發送
- ✅ 判斷邏輯：排除已取消預約後，時間最早的預約
- ✅ 時間相同時：選擇ID較小的預約

#### **非活躍預約（不可操作）**

以下預約顯示 read-only 狀態（灰色）：
- ❌ **非最早預約**：顯示「已合併」（已在 v2.1 實現）
- ❌ **已取消預約**：顯示灰色「已取消」
- ❌ **已送達預約**：顯示「已送達」
- ❌ **已過期預約**：顯示「已過期」

---

## 🎯 業務規則總結

### **預約查詢-預約簡訊管理 使用說明**

#### **活躍預約**
- **後端**：新增API給前端判斷可否操作
- **前端判斷邏輯**：
  - 只有最早的有效預約可以操作簡訊狀態
  - 支援的操作：發送、取消、重新發送
  - 時間相同的預約會選擇ID較小的操作

#### **非活躍預約**
- **非最早預約**：維持原本的簡訊管理狀態（read only）
  - 後端新增API給前端判斷不可操作
- **已取消/已刪除預約**：顯示「已取消」（read only）
  - 前端看最後狀態判斷不可操作
- **已送達或已過期預約**：（read only）
  - 前端看最後判斷不可操作

#### **自動補位**
- ✅ **當取消預約時**，系統會自動檢查並更新新的最早預約
- ❌ **取消簡訊不會觸發**自動補位

#### **狀態顯示**
- 不可操作狀態使用灰色

---

## 🔄 行為變更對比

### **取消操作的區別**

| 操作類型 | 位置 | 作用 | 觸發補位 | 預約狀態 | 簡訊狀態 |
|---------|------|------|---------|---------|---------|
| **取消簡訊** | 簡訊管理欄 | 不發送簡訊通知 | ❌ 否 | 不變 | cancelled |
| **取消預約** | 取消預約欄 | 預約本身取消 | ✅ 是 | cancelled | 不變 |

### **情境5觸發時機**

#### **變更前（錯誤）**
```
點擊「取消簡訊」→ 觸發情境5 ❌
```

#### **變更後（正確）**
```
點擊「取消預約」→ 檢查同日其他預約 → 有 → 觸發情境5 ✅
                                    → 無 → 標準取消確認
```

---

## 🧪 測試案例

### **測試 1：取消簡訊 vs 取消預約**

#### **測試對象**
- **張大華（M003）** - 2025/11/02
  - ID 29: 11:00 - 電痛衝導入（排程中）
  - ID 30: 17:00 - 2樓總店-【醫美】（未發送）

#### **測試步驟 A：取消簡訊**
1. 找到「張大華 11:00」（ID 29）
2. 懸停「排程中」→ 點擊「取消」
3. 確認取消

**預期結果：**
- ID 29: 排程中 → 已取消
- ID 30: **繼續顯示「已合併」**（不觸發補位）
- ID 29 仍然是最早預約（預約本身未取消）

#### **測試步驟 B：取消預約**
1. 重新載入頁面
2. 找到「張大華 11:00」（ID 29）
3. 點擊「取消預約」按鈕
4. 觀察彈窗

**預期結果：**
- 顯示情境5彈窗（自動補位通知）
- 補位預約：17:00（ID 30）
- 確認後：
  - ID 29: appointmentStatus = 'cancelled'，簡訊管理顯示灰色「已取消」
  - ID 30: 變為可操作，簡訊狀態變為「排程中」

---

### **測試 2：活躍預約判斷（時間相同選ID小）**

#### **測試數據**
添加測試數據：
```javascript
{id: 32, date: '2025/11/03', member: 'M004', name: '測試會員',
 time: '10:00', smsStatus: '', appointmentStatus: ''},
{id: 33, date: '2025/11/03', member: 'M004', name: '測試會員',
 time: '10:00', smsStatus: '', appointmentStatus: ''}, // 時間相同
{id: 34, date: '2025/11/03', member: 'M004', name: '測試會員',
 time: '14:00', smsStatus: '', appointmentStatus: ''}
```

**預期結果：**
- ID 32: 可操作（時間最早，且ID最小）
- ID 33: 顯示「已合併」（時間相同但ID較大）
- ID 34: 顯示「已合併」（時間較晚）

---

### **測試 3：已取消預約顯示**

#### **測試步驟**
1. 取消某個預約（使用「取消預約」按鈕）
2. 確認取消
3. 觀察表格顯示

**預期結果：**
- **簡訊管理欄**：顯示灰色「已取消」（read only，無懸停效果）
- **取消預約欄**：顯示灰色「已取消」文字
- **聯絡狀況欄**：仍可正常編輯

---

## 📊 狀態流轉圖

### **取消預約的完整流程**

```
用戶點擊「取消預約」
    ↓
檢查是否過期？
    YES → 提示「診療時間已過，無法取消預約」
    NO ↓
    ↓
查找同日其他活躍預約
    ↓
    有其他活躍預約？
    ↓
    YES                           NO
    ↓                             ↓
觸發情境5（自動補位）          顯示標準取消確認框
    ↓                             ↓
顯示補位彈窗                   用戶確認
    ↓                             ↓
用戶確認發送                   appointmentStatus = 'cancelled'
    ↓                             ↓
原預約: appointmentStatus = 'cancelled'    表格重新渲染
補位預約: smsStatus = 'scheduled'          ↓
    ↓                          簡訊管理顯示灰色「已取消」
表格重新渲染                    取消預約顯示灰色「已取消」
```

---

## 🔧 技術實現

### **1. 新增函數**

#### **generateCancelAppointmentButton()**
```javascript
function generateCancelAppointmentButton(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);

    // 已取消或已過期，不顯示按鈕
    if (appointment.appointmentStatus === 'cancelled') {
        return '<span style="color: #9e9e9e;">已取消</span>';
    }
    if (isAppointmentExpired(appointmentId)) {
        return '<span style="color: #9e9e9e;">已過期</span>';
    }

    // 顯示取消預約按鈕
    return '<button ... onclick="cancelAppointment(' + appointmentId + ')">取消預約</button>';
}
```

#### **cancelAppointment()**
```javascript
function cancelAppointment(appointmentId) {
    const sameDayApts = getSameDayAppointments(...);

    if (sameDayApts.length > 0) {
        // 觸發情境5（自動補位）
        showReplacementModal(appointment, nextAppointment, sameDayApts);
    } else {
        // 標準取消預約流程
        showStandardCancelModal(...);
    }
}
```

---

### **2. 修改函數**

#### **generateActionButtons()**
```javascript
// 新增檢查：預約已取消時顯示灰色「已取消」
if (appointment.appointmentStatus === 'cancelled') {
    return '<span class="sms-status-block status-expired"
            style="background: #f5f5f5; color: #9e9e9e;">已取消</span>';
}
```

#### **getSameDayAppointments()**
```javascript
// 修改排序邏輯：時間相同時選擇ID較小的
.sort(function(a, b) {
    const timeCompare = a.time.localeCompare(b.time);
    if (timeCompare !== 0) return timeCompare;
    return a.id - b.id; // 時間相同時，選ID較小的
});
```

#### **confirmSms()**
```javascript
// 情境5時，更新被取消預約的狀態
if (pendingCanceledAppointmentId !== null) {
    const canceledApt = appointments.find(apt => apt.id === pendingCanceledAppointmentId);
    canceledApt.appointmentStatus = 'cancelled';
}
```

---

## 🎨 視覺效果

### **「取消預約」欄位樣式**

| 預約狀態 | 顯示內容 | 樣式 | 可點擊 |
|---------|---------|------|--------|
| 正常 | 「取消預約」按鈕 | 紅色按鈕 | ✅ 是 |
| 已取消 | 「已取消」文字 | 灰色 #9e9e9e | ❌ 否 |
| 已過期 | 「已過期」文字 | 灰色 #9e9e9e | ❌ 否 |

### **簡訊管理欄位（已取消預約）**

```css
/* 預約已取消時的簡訊管理狀態 */
background: #f5f5f5;  /* 淺灰色背景 */
color: #9e9e9e;       /* 灰色文字 */
cursor: default;      /* 標準游標（不可點擊） */
```

---

## 📝 數據結構

### **新增字段**

```javascript
{
    id: 29,
    date: '2025/11/02',
    member: 'M003',
    name: '張大華',
    time: '11:00',
    treatment: '電痛衝導入',
    smsStatus: 'scheduled',        // 簡訊狀態
    appointmentStatus: '',         // 預約狀態（新增）
    noSmsPreference: false
}
```

### **狀態值定義**

#### **appointmentStatus（預約狀態）**
- `''` 或 `undefined`: 預約有效（預設值）
- `'cancelled'`: 預約已取消

#### **smsStatus（簡訊狀態）**
- `''`: 未發送
- `'scheduled'`: 排程中
- `'delivered'`: 已送達
- `'cancelled'`: 已取消（簡訊）
- `'failed'`: 發送失敗

---

## 💡 常見問題

### Q1：取消簡訊和取消預約有什麼區別？

**A：**
- **取消簡訊**：只是不發送簡訊通知，預約本身仍然有效，客戶仍會來診
- **取消預約**：預約本身被取消，客戶不會來診，會觸發自動補位機制

### Q2：為什麼取消簡訊不觸發自動補位？

**A：** 因為取消簡訊只是不發送通知，預約本身仍然有效，所以它仍然是「最早預約」，不需要補位。

### Q3：如果取消預約後又想恢復怎麼辦？

**A：** 目前版本不支援恢復已取消的預約。建議在取消前仔細確認。

### Q4：時間相同的預約為什麼選ID較小的？

**A：** 這是為了確保判斷結果的確定性。當兩個預約時間完全相同時，系統會優先選擇ID較小的（即較早創建的）作為最早預約。

### Q5：已取消的預約還能編輯聯絡狀況嗎？

**A：** 可以。「聯絡狀況」欄位不受預約取消影響，仍可正常編輯。

---

## 🚀 升級建議

### **從 v2.1 升級到 v2.2**

1. **備份當前版本**
   ```bash
   cp 預約查詢互動.html 預約查詢互動_v2.1_backup.html
   ```

2. **替換為新版本**
   - 新增「取消預約」欄位
   - 新增相關函數

3. **數據遷移**
   - 為所有現有預約添加 `appointmentStatus` 字段（預設為空字符串）

4. **測試重點**
   - 取消簡訊 vs 取消預約的區別
   - 情境5自動補位邏輯
   - 時間相同預約的判斷
   - 已取消預約的顯示

---

## 📖 相關文檔

- `最早預約邏輯說明.md` - 最早預約判斷邏輯詳解
- `更新說明_已合併狀態.md` - v2.1 已合併狀態說明
- `測試指南_完整版.md` - 情境1-5測試指南
- `原型說明_完整版.md` - 技術架構說明

---

## ✅ 檢查清單

開發完成後請確認：

- [ ] 表格新增「取消預約」欄位
- [ ] 「取消預約」按鈕正常顯示
- [ ] 取消簡訊不觸發補位
- [ ] 取消預約觸發情境5
- [ ] 已取消預約顯示灰色「已取消」
- [ ] 時間相同預約選ID較小的
- [ ] 已取消預約的簡訊管理 read-only
- [ ] 聯絡狀況仍可正常編輯
- [ ] 所有測試案例通過

---

**更新完成！建議按照測試案例逐一驗證功能。**
